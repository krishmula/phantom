name: Deploy CloudFormation on PR Merge

on:
  push:
    branches:
      - main
    paths:
      - 'cloudformation/infrastructure_cft.json'

jobs:
  deploy:
    name: Sync CFN Stack with AWS
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      # ---------------------------------------------------------- #
      # 3. Use the corrected template directly — no extraction needed
      # ---------------------------------------------------------- #
      - name: Prepare CFN template
        run: |
          cp cloudformation/infrastructure_cft.json template.json
          echo "Template ready ✓"
          echo "=== Preview ==="
          cat template.json | python3 -m json.tool | head -20

      # ---------------------------------------------------------- #
      # 4. Deploy to CloudFormation                                 #
      # ---------------------------------------------------------- #
      - name: Deploy CloudFormation Stack
        run: |
          STACK_NAME="${{ secrets.STACK_NAME }}"

          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" > /dev/null 2>&1; then
            echo "Stack exists — running update"

            UPDATE_OUTPUT=$(aws cloudformation update-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://template.json \
              --capabilities CAPABILITY_NAMED_IAM 2>&1) || true

            echo "Update output: $UPDATE_OUTPUT"

            if echo "$UPDATE_OUTPUT" | grep -q "No updates are to be performed"; then
              echo "✅ Stack already in sync — no changes needed"
              exit 0
            elif echo "$UPDATE_OUTPUT" | grep -q "StackId"; then
              echo "⏳ Waiting for update to complete..."
              aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"
              echo "✅ Stack updated successfully"
            else
              echo "❌ Error: $UPDATE_OUTPUT"
              exit 1
            fi

          else
            echo "Stack not found — running create"
            aws cloudformation create-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://template.json \
              --capabilities CAPABILITY_NAMED_IAM

            aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME"
            echo "✅ Stack created successfully"
          fi

      # ---------------------------------------------------------- #
      # 5. Print final stack status                                 #
      # ---------------------------------------------------------- #
      - name: Print Stack Status
        if: always()
        run: |
          aws cloudformation describe-stacks \
            --stack-name "${{ secrets.STACK_NAME }}" \
            --query "Stacks[0].{Status:StackStatus,Updated:LastUpdatedTime}" \
            --output table
